{% extends 'base.html.twig' %}

{% block title %}Casino{% endblock %}

{% block content %}
<div>
   <button onclick="connectWallet()">Connecter RabbiWallet</button>
   <button onclick="enterGame()">Entrer dans la partie</button>
   <button onclick="getPlayers()">Voir les joueurs</button>
   <button onclick="isGameOver()">Le jeu est-il terminé ?</button>
   <button onclick="pickWinner()">Tirer le gagnant (admin)</button>
</div>

<div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
<script>

        window.addEventListener('load', function () {
        let web3;

        if (typeof window.ethereum !== 'undefined') {
        web3 = new Web3(window.ethereum);

        ethereum.request({ method: 'eth_requestAccounts' })
        .then(accounts => {
        console.log('Compte connecté :', accounts[0]);
    })
        .catch(error => {
        console.error('Erreur lors de la connexion au portefeuille:', error);
    });
    } else {
        console.log('MetaMask n\'est pas installé.');
    }

        function connectWallet() {
        if (web3) {
        console.log('Web3 est prêt, portefeuille connecté.');
    } else {
        console.log('Web3 n\'est pas disponible.');
    }
    }
        document.getElementById('connect-wallet-button').addEventListener('click', connectWallet);
    });

    const contractAddress = 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0;
    const contractABI = {
        "_format": "hh-sol-artifact-1",
        "contractName": "Casino",
        "sourceName": "contracts/Casino.sol",
        "abi": [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "startTime",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "duration",
                        "type": "uint256"
                    }
                ],
                "name": "GameStarted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    }
                ],
                "name": "PlayerJoined",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "requestId",
                        "type": "uint256"
                    }
                ],
                "name": "WinnerRequested",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "winner",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "prize",
                        "type": "uint256"
                    }
                ],
                "name": "WinnerSelected",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "countdownStarted",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "enterGame",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "gameDuration",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "gameStartTime",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPlayers",
                "outputs": [
                    {
                        "internalType": "address[]",
                        "name": "",
                        "type": "address[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "isGameOver",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "pickWinner",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "players",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "winnerRequested",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ],
        "bytecode": "0x608060405260b46003556000600460006101000a81548160ff0219169083151502179055506000600460016101000a81548160ff02191690831515021790555034801561004b57600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610d3e8061009b6000396000f3fe6080604052600436106100915760003560e01c80638b5b9ccc116100595780638b5b9ccc146101385780638da5cb5b14610163578063dbd886b61461018e578063e1f0c376146101b9578063f71d96cb146101e457610091565b80630252b995146100965780630e04a7d8146100c1578063218bd577146100ec57806350653369146100f65780635d495aea14610121575b600080fd5b3480156100a257600080fd5b506100ab610221565b6040516100b891906107e3565b60405180910390f35b3480156100cd57600080fd5b506100d6610227565b6040516100e39190610819565b60405180910390f35b6100f4610259565b005b34801561010257600080fd5b5061010b6103cb565b6040516101189190610819565b60405180910390f35b34801561012d57600080fd5b506101366103de565b005b34801561014457600080fd5b5061014d610602565b60405161015a9190610924565b60405180910390f35b34801561016f57600080fd5b50610178610690565b6040516101859190610955565b60405180910390f35b34801561019a57600080fd5b506101a36106b4565b6040516101b09190610819565b60405180910390f35b3480156101c557600080fd5b506101ce6106c7565b6040516101db91906107e3565b60405180910390f35b3480156101f057600080fd5b5061020b600480360381019061020691906109a1565b6106cd565b6040516102189190610955565b60405180910390f35b60025481565b6000600460009054906101000a900460ff168015610254575060035460025461025091906109fd565b4210155b905090565b6000341161029c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029390610a8e565b60405180910390fd5b6001339080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503373ffffffffffffffffffffffffffffffffffffffff167f31e760aa525306aba638a784082a013b6a1cc0a9a1789f3f22281c0453b10b1f60405160405180910390a260026001805490501480156103645750600460009054906101000a900460ff16155b156103c957426002819055506001600460006101000a81548160ff0219169083151502179055507fa2dfaa3573b86004ec9d4d4abe5068d942579c59da4da8cd0d9e45e71a393bc16002546003546040516103c0929190610aae565b60405180910390a15b565b600460019054906101000a900460ff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461046c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161046390610b23565b60405180910390fd5b610474610227565b6104b3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104aa90610b8f565b60405180910390fd5b600260018054905010156104fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104f390610bfb565b60405180910390fd5b600060018054905061050c61070c565b6105169190610c4a565b905060006001828154811061052e5761052d610c7b565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905060004790508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156105a6573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167f75060f9e79552df167b73353fee6237a75bb5ba8ea022f77224e32f152138bcb826040516105ed91906107e3565b60405180910390a26105fd610746565b505050565b6060600180548060200260200160405190810160405280929190818152602001828054801561068657602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161063c575b5050505050905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600460009054906101000a900460ff1681565b60035481565b600181815481106106dd57600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000424460018054905060405160200161072893929190610ccb565b6040516020818303038152906040528051906020012060001c905090565b60016000610754919061078c565b6000600460006101000a81548160ff0219169083151502179055506000600460016101000a81548160ff021916908315150217905550565b50805460008255906000526020600020908101906107aa91906107ad565b50565b5b808211156107c65760008160009055506001016107ae565b5090565b6000819050919050565b6107dd816107ca565b82525050565b60006020820190506107f860008301846107d4565b92915050565b60008115159050919050565b610813816107fe565b82525050565b600060208201905061082e600083018461080a565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061088b82610860565b9050919050565b61089b81610880565b82525050565b60006108ad8383610892565b60208301905092915050565b6000602082019050919050565b60006108d182610834565b6108db818561083f565b93506108e683610850565b8060005b838110156109175781516108fe88826108a1565b9750610909836108b9565b9250506001810190506108ea565b5085935050505092915050565b6000602082019050818103600083015261093e81846108c6565b905092915050565b61094f81610880565b82525050565b600060208201905061096a6000830184610946565b92915050565b600080fd5b61097e816107ca565b811461098957600080fd5b50565b60008135905061099b81610975565b92915050565b6000602082840312156109b7576109b6610970565b5b60006109c58482850161098c565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610a08826107ca565b9150610a13836107ca565b9250828201905080821115610a2b57610a2a6109ce565b5b92915050565b600082825260208201905092915050565b7f4d697365206f626c696761746f69726500000000000000000000000000000000600082015250565b6000610a78601083610a31565b9150610a8382610a42565b602082019050919050565b60006020820190508181036000830152610aa781610a6b565b9050919050565b6000604082019050610ac360008301856107d4565b610ad060208301846107d4565b9392505050565b7f4e6f74206f776e65720000000000000000000000000000000000000000000000600082015250565b6000610b0d600983610a31565b9150610b1882610ad7565b602082019050919050565b60006020820190508181036000830152610b3c81610b00565b9050919050565b7f4c65206a6575206e2765737420706173207465726d696ec3a900000000000000600082015250565b6000610b79601983610a31565b9150610b8482610b43565b602082019050919050565b60006020820190508181036000830152610ba881610b6c565b9050919050565b7f50617320617373657a206465206a6f7565757273000000000000000000000000600082015250565b6000610be5601483610a31565b9150610bf082610baf565b602082019050919050565b60006020820190508181036000830152610c1481610bd8565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610c55826107ca565b9150610c60836107ca565b925082610c7057610c6f610c1b565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b610cc5610cc0826107ca565b610caa565b82525050565b6000610cd78286610cb4565b602082019150610ce78285610cb4565b602082019150610cf78284610cb4565b60208201915081905094935050505056fea264697066735822122089f27bb9dd4f80eb309f5a75dff50b61486ddaeb06ee4c7db07dd57836ef00db64736f6c63430008140033",
        "deployedBytecode": "0x6080604052600436106100915760003560e01c80638b5b9ccc116100595780638b5b9ccc146101385780638da5cb5b14610163578063dbd886b61461018e578063e1f0c376146101b9578063f71d96cb146101e457610091565b80630252b995146100965780630e04a7d8146100c1578063218bd577146100ec57806350653369146100f65780635d495aea14610121575b600080fd5b3480156100a257600080fd5b506100ab610221565b6040516100b891906107e3565b60405180910390f35b3480156100cd57600080fd5b506100d6610227565b6040516100e39190610819565b60405180910390f35b6100f4610259565b005b34801561010257600080fd5b5061010b6103cb565b6040516101189190610819565b60405180910390f35b34801561012d57600080fd5b506101366103de565b005b34801561014457600080fd5b5061014d610602565b60405161015a9190610924565b60405180910390f35b34801561016f57600080fd5b50610178610690565b6040516101859190610955565b60405180910390f35b34801561019a57600080fd5b506101a36106b4565b6040516101b09190610819565b60405180910390f35b3480156101c557600080fd5b506101ce6106c7565b6040516101db91906107e3565b60405180910390f35b3480156101f057600080fd5b5061020b600480360381019061020691906109a1565b6106cd565b6040516102189190610955565b60405180910390f35b60025481565b6000600460009054906101000a900460ff168015610254575060035460025461025091906109fd565b4210155b905090565b6000341161029c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029390610a8e565b60405180910390fd5b6001339080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503373ffffffffffffffffffffffffffffffffffffffff167f31e760aa525306aba638a784082a013b6a1cc0a9a1789f3f22281c0453b10b1f60405160405180910390a260026001805490501480156103645750600460009054906101000a900460ff16155b156103c957426002819055506001600460006101000a81548160ff0219169083151502179055507fa2dfaa3573b86004ec9d4d4abe5068d942579c59da4da8cd0d9e45e71a393bc16002546003546040516103c0929190610aae565b60405180910390a15b565b600460019054906101000a900460ff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461046c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161046390610b23565b60405180910390fd5b610474610227565b6104b3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104aa90610b8f565b60405180910390fd5b600260018054905010156104fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104f390610bfb565b60405180910390fd5b600060018054905061050c61070c565b6105169190610c4a565b905060006001828154811061052e5761052d610c7b565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905060004790508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156105a6573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167f75060f9e79552df167b73353fee6237a75bb5ba8ea022f77224e32f152138bcb826040516105ed91906107e3565b60405180910390a26105fd610746565b505050565b6060600180548060200260200160405190810160405280929190818152602001828054801561068657602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161063c575b5050505050905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600460009054906101000a900460ff1681565b60035481565b600181815481106106dd57600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000424460018054905060405160200161072893929190610ccb565b6040516020818303038152906040528051906020012060001c905090565b60016000610754919061078c565b6000600460006101000a81548160ff0219169083151502179055506000600460016101000a81548160ff021916908315150217905550565b50805460008255906000526020600020908101906107aa91906107ad565b50565b5b808211156107c65760008160009055506001016107ae565b5090565b6000819050919050565b6107dd816107ca565b82525050565b60006020820190506107f860008301846107d4565b92915050565b60008115159050919050565b610813816107fe565b82525050565b600060208201905061082e600083018461080a565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061088b82610860565b9050919050565b61089b81610880565b82525050565b60006108ad8383610892565b60208301905092915050565b6000602082019050919050565b60006108d182610834565b6108db818561083f565b93506108e683610850565b8060005b838110156109175781516108fe88826108a1565b9750610909836108b9565b9250506001810190506108ea565b5085935050505092915050565b6000602082019050818103600083015261093e81846108c6565b905092915050565b61094f81610880565b82525050565b600060208201905061096a6000830184610946565b92915050565b600080fd5b61097e816107ca565b811461098957600080fd5b50565b60008135905061099b81610975565b92915050565b6000602082840312156109b7576109b6610970565b5b60006109c58482850161098c565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610a08826107ca565b9150610a13836107ca565b9250828201905080821115610a2b57610a2a6109ce565b5b92915050565b600082825260208201905092915050565b7f4d697365206f626c696761746f69726500000000000000000000000000000000600082015250565b6000610a78601083610a31565b9150610a8382610a42565b602082019050919050565b60006020820190508181036000830152610aa781610a6b565b9050919050565b6000604082019050610ac360008301856107d4565b610ad060208301846107d4565b9392505050565b7f4e6f74206f776e65720000000000000000000000000000000000000000000000600082015250565b6000610b0d600983610a31565b9150610b1882610ad7565b602082019050919050565b60006020820190508181036000830152610b3c81610b00565b9050919050565b7f4c65206a6575206e2765737420706173207465726d696ec3a900000000000000600082015250565b6000610b79601983610a31565b9150610b8482610b43565b602082019050919050565b60006020820190508181036000830152610ba881610b6c565b9050919050565b7f50617320617373657a206465206a6f7565757273000000000000000000000000600082015250565b6000610be5601483610a31565b9150610bf082610baf565b602082019050919050565b60006020820190508181036000830152610c1481610bd8565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610c55826107ca565b9150610c60836107ca565b925082610c7057610c6f610c1b565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b610cc5610cc0826107ca565b610caa565b82525050565b6000610cd78286610cb4565b602082019150610ce78285610cb4565b602082019150610cf78284610cb4565b60208201915081905094935050505056fea264697066735822122089f27bb9dd4f80eb309f5a75dff50b61486ddaeb06ee4c7db07dd57836ef00db64736f6c63430008140033",
        "linkReferences": {},
        "deployedLinkReferences": {}
    }


        let web3;
    let casino;

    async function connectWallet() {
        if (window.RabbiWallet) {
            web3 = new Web3(window.RabbiWallet);
            await window.RabbiWallet.request({ method: 'eth_requestAccounts' });
            casino = new web3.eth.Contract(contractABI, contractAddress);
            log("RabbiWallet connecté");
        } else if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            casino = new web3.eth.Contract(contractABI, contractAddress);
            log("MetaMask connecté");
        } else {
            alert("Aucun portefeuille détecté");
        }
    }

    async function enterGame() {
        const accounts = await web3.eth.getAccounts();
        await casino.methods.enterGame().send({ from: accounts[0], value: web3.utils.toWei("0.01", "ether") });
        log("Entré dans la partie");
    }

    async function getPlayers() {
        const players = await casino.methods.getPlayers().call();
        log("Joueurs : " + players.join(", "));
    }

    async function isGameOver() {
        const over = await casino.methods.isGameOver().call();
        log("Le jeu est-il terminé ? " + over);
    }

    async function pickWinner() {
        const accounts = await web3.eth.getAccounts();
        await casino.methods.pickWinner().send({ from: accounts[0] });
        log("Tirage en cours...");
    }

    function log(message) {
        document.getElementById("output").innerText = message;
    }
</script>

{% endblock %}